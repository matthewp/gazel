function createUuid(t,e){for(e=t="";36>t++;e+=52&51*t?(15^t?8^Math.random()*(20^t?16:4):4).toString(16):"-");return e}function Dict(){this.items={}}function Trans(){Dict.call(this)}function Client(){this.chain=[],this.inMulti=!1,this.returned=[],this.trans=new Trans,this.transMap=new Dict,this.events=new Dict}function openDatabase(t,e,n){if(db&&db.version==gazel.version&&db.name===gazel.dbName)return t(db),void 0;if(loadingDb)return setTimeout(function(){openDatabase(t,e)},100),void 0;loadingDb=!0;var r=window.indexedDB.open(gazel.dbName,gazel.version);r.onupgradeneeded=function(t){var e=t.target.result;e.objectStoreNames.contains(gazel.osName)||e.createObjectStore(gazel.osName),n&&n(e)};var i;i=r.onsuccess=function(n){var o=n.target.result;if(o.setVersion&&Number(o.version)!==gazel.version){db&&db.close();var s=o.setVersion(gazel.version+"");return s.onsuccess=function(t){var e={};e.target={},e.target.result=t.target.result.db,r.onupgradeneeded(e),i(e)},s.onerror=e,s.onfailure=e,s.onblocked=e,void 0}db=o,loadingDb=!1,t(db)},r.onerror=function(r){return r&&12===r.target.errorCode?(gazel.version++,openDatabase(t,e,n),void 0):(e(r),void 0)},r.onblocked=e}function ensureObjectStore(t,e,n){openDatabase(function(r){return r.objectStoreNames.contains(t)?(e(),void 0):(r.close(),gazel.version++,ensureObjectStore(t,e,n),void 0)},n,function(e){e.objectStoreNames.contains(t)||e.createObjectStore(t)})}var gazel=gazel||{},exists=function(t){return t!==void 0&&null!=t},isInt=function(t){return!isNaN(t)&&0===t%1};window.indexedDB=window.indexedDB||window.mozIndexedDB||window.msIndexedDB||window.webkitIndexedDB||window.oIndexedDB,window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction,window.IDBTransaction.READ_ONLY=window.IDBTransaction.READ_ONLY||"readonly",window.IDBTransaction.READ_WRITE=window.IDBTransaction.READ_WRITE||"readwrite";var slice=Array.prototype.slice;Dict.prototype={prop:function(t){return":"+t},get:function(t,e){var n=this.prop(t),r=this.items;return r.hasOwnProperty(n)?r[n]:e},set:function(t,e){var n=this.prop(t);return this.items[n]=e,e},count:function(){return Object.keys(this.items).length},has:function(t){var e=this.prop(t);return this.items.hasOwnProperty(e)},del:function(t){var e=this.prop(t),n=this.items;n.hasOwnProperty(e)&&delete n[e]},keys:function(){return Object.keys(this.items).map(function(t){return t.substring(1)})}},Trans.prototype=Object.create(Dict.prototype),Trans.prototype.constructor=Trans,Trans.prototype.add=function(){var t=createUuid();return this.set(t,void 0),t},Trans.prototype.abortAll=function(){var t=this,e=t.keys();e.forEach(function(e){var n=t.get(e);n&&n.abort(),t.del(e)})},Trans.prototype.pull=function(t,e,n,r){var i=this.get(n);return i||(i=t.transaction([e],r),i.onerror=onerror,this.set(n,i)),i},Client.prototype={register:function(t,e,n){var r,i=this;return this.needsOsVerification?(ensureObjectStore(this.osName,function(){i.needsOsVerification=!1,i.register(t,e,n)},this.handleError.bind(this)),void 0):this.inMulti?(r=this.transMap.get(t),r||(r=this.trans.add(),this.transMap.set(t,r)),this.chain.push({uuid:r,action:e}),void 0):(r=i.trans.add(),e(r,function(){var t=slice.call(arguments);i.trans.del(r),(n||function(){}).apply(null,t)}),void 0)},flush:function(){var t=slice.call(arguments)||[];if(this.returned.push(t),0===this.chain.length)return this.complete(),void 0;var e=this.chain.shift();e.action.call(this,e.uuid,this.flush)},multi:function(){return this.chain=[],this.inMulti=!0,this},exec:function(t){this.inMulti=!1,this.complete=function(){var e=this,n=this.returned;this.complete=null,this.chain=null,this.returned=[],this.transMap.keys().forEach(function(t){var n=e.transMap.get(t);e.trans.del(n)}),this.transMap=new Dict,t(n)};var e=this.chain.shift();e.action.call(this,e.uuid,this.flush)},on:function(t,e){var n=this.events.get(t);n||(n=[],this.events.set(t,n)),n.push(e)},off:function(t,e){if(!e)return this.events.del(t),void 0;var n=this.events.get(t);n.splice(n.indexOf(e),1)},emit:function(t){var e=slice.call(arguments,1),n=this;setTimeout(function(){(n.events.get(t)||[]).forEach(function(t){t.apply(null,e)})})}},Client.prototype.discard=function(t){try{this.trans.abortAll(),(t||function(){})("OK")}catch(e){this.handleError(e)}},Client.prototype.handleError=function(){var t=["error"].concat(slice.call(arguments));this.emit.apply(this,t)},Client.prototype.get=function(t,e){var n=this;return this.register("read",function(e,r){openDatabase(function(i){var o=n.trans.pull(i,n.osName,e,IDBTransaction.READ_ONLY),s=o.objectStore(n.osName).get(t);s.onerror=n.handleError.bind(n),s.onsuccess=function(t){r.call(n,t.target.result)}},n.handleError.bind(n))},e),this},Client.prototype.set=function(t,e,n){return this.register("write",this._set(t,e),n),this},Client.prototype._set=function(t,e){var n=this;return function(r,i){openDatabase(function(o){var s=n.trans.pull(o,n.osName,r,IDBTransaction.READ_WRITE),a=s.objectStore(n.osName).put(e,t);a.onerror=n.handleError.bind(n),a.onsuccess=function(r){var o=r.target.result===t?"OK":"ERR";n.emit("set",t,e),i.call(n,o)}},n.handleError.bind(n))}},Client.prototype.incrby=function(t,e,n){var r=this;return this.register("write",function(n,i){openDatabase(function(o){var s=r.trans.pull(o,r.osName,n,IDBTransaction.READ_WRITE),a=s.objectStore(r.osName);(function c(n){var o;if(!exists(n))return o=a.get(t),o.onerror=r.handleError.bind(r),o.onsuccess=function(t){c(t.target.result===void 0?0:t.target.result)},void 0;if(!isInt(n))return r.handleError("ERROR: Cannot increment a non-integer value.");var s=n+e;o=a.put(s,t),o.onerror=r.handleError.bind(r),o.onsuccess=function(e){var n=e.target.result===t?s:"ERR";r.emit("set",t,s),i.call(r,n)}})()},r.handleError.bind(r))},n),this},Client.prototype.incr=function(t,e){return this.incrby(t,1,e)},Client.prototype.decrby=function(t,e,n){return this.incrby(t,-e,n)},Client.prototype.decr=function(t,e){return this.incrby(t,-1,e)},Client.prototype.del=function(){var t=slice.call(arguments),e=t[t.length>0?t.length-1:0];return"function"!=typeof e?e=void 0:t.splice(t.length-1),this.register("write",this._del(t),e),this},Client.prototype._del=function(t){var e=this,n=t.length;return function(r,i){openDatabase(function(o){for(var s=e.trans.pull(o,e.osName,r,IDBTransaction.READ_WRITE),a=s.objectStore(e.osName),c=t.length,u=function(){var r=t.shift(),o=a.delete(r);o.onerror=e.handleError.bind(e),o.onsuccess=function(){c--,e.emit("delete",r),0===c&&i.call(e,n)}};t.length>0;)u()})}},gazel.print=function(){var t=slice.call(arguments);0!==t.length&&(Array.isArray(t[0])?t[0]:[t[0]]).forEach(function(t){console.log(t)})},gazel.dbName="gazeldb",gazel.osName="gazelos";var VERSION_KEY="_gazel.version",version=localStorage[VERSION_KEY]&&0|localStorage[VERSION_KEY]||1;Object.defineProperty(gazel,"version",{get:function(){return version},set:function(t){version=t,localStorage[VERSION_KEY]=t}}),gazel.compatible=exists(window.indexedDB)&&exists(window.IDBTransaction),gazel.createClient=function(t){var e=new Client;return e.osName=t||gazel.osName,t&&(e.needsOsVerification=!0),e},this.gazel=gazel;var db,loadingDb=!1;