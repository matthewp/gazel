(function(){function s(e,t){for(t=e="";e++<36;t+=e*51&52?(e^15?8^Math.random()*(e^20?16:4):4).toString(16):"-");return t}function o(){this.items={}}function u(){o.call(this)}function a(){this.chain=[],this.inMulti=!1,this.returned=[],this.trans=new u,this.transMap=new o,this.events=new o}function c(t,n,r){if(f&&f.version==e.version){t(f);return}if(l){setTimeout(function(){c(t,n)},100);return}l=!0;var i=window.indexedDB.open(e.dbName,e.version);i.onupgradeneeded=function(t){var n=t.target.result;n.objectStoreNames.contains(e.osName)||n.createObjectStore(e.osName),r&&r(n)};var s;s=i.onsuccess=function(r){var o=r.target.result;if(o.setVersion&&Number(o.version)!==e.version){f&&f.close();var u=o.setVersion(String(e.version));u.onsuccess=function(e){var t={};t.target={},t.target.result=e.target.result.db,i.onupgradeneeded(t),s(t);return},u.onerror=n,u.onfailure=n,u.onblocked=n;return}f=o,l=!1,t(f)},i.onerror=n}function h(t,n,r){e.version++,c(function(){n()},r,function(e){e.objectStoreNames.contains(t)||e.createObjectStore(t)})}var e=e||{},t=function(e){return typeof e!="undefined"&&e!=null},n=function(e){return!isNaN(e)&&e%1==0};window.indexedDB=window.indexedDB||window.mozIndexedDB||window.msIndexedDB||window.webkitIndexedDB||window.oIndexedDB,window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction,window.IDBTransaction.READ_ONLY=window.IDBTransaction.READ_ONLY||"readonly",window.IDBTransaction.READ_WRITE=window.IDBTransaction.READ_WRITE||"readwrite";var r=Array.prototype.slice,i=Array.prototype.splice;o.prototype={prop:function(e){return":"+e},get:function(e,t){var n=this.prop(e),r=this.items;return r.hasOwnProperty(n)?r[n]:t},set:function(e,t){var n=this.prop(e);return this.items[n]=t,t},count:function(){return Object.keys(this.items).length},has:function(e){var t=this.prop(e);return this.items.hasOwnProperty(t)},del:function(e){var t=this.prop(e),n=this.items;n.hasOwnProperty(t)&&delete n[t]},keys:function(){return Object.keys(this.items).map(function(e){return e.substring(1)})}},u.prototype=o.prototype,u.prototype.constructor=u,u.prototype.add=function(){var e=s();return this.set(e,undefined),e},u.prototype.abortAll=function(){var e=this,t=e.keys();t.forEach(function(t){var n=e.get(t);n&&n.abort(),e.del(t)})},u.prototype.pull=function(e,t,n,r){var i=this.get(n);return i||(i=e.transaction([t],r),i.onerror=onerror,this.set(n,i)),i},a.prototype={register:function(e,t,n){var i,s=this;if(this.needsOsVerification){h(this.osName,function(){s.needsOsVerification=!1,s.register(e,t,n)},this.handleError.bind(this));return}if(this.inMulti){i=this.transMap.get(e),i||(i=this.trans.add(),this.transMap.set(e,i)),this.chain.push({uuid:i,action:t});return}i=s.trans.add(),t(i,function(){var e=r.call(arguments);s.trans.del(i),(n||function(){}).apply(null,e)})},flush:function(){var e=r.call(arguments)||[];this.returned.push(e);if(this.chain.length===0){this.complete();return}var t=this.chain.shift();t.action.call(this,t.uuid,this.flush)},multi:function(){return this.chain=[],this.inMulti=!0,this},exec:function(e){this.inMulti=!1,this.complete=function(){var t=this,n=this.returned;this.complete=null,this.chain=null,this.returned=[],this.transMap.keys().forEach(function(e){var n=t.transMap.get(e);t.trans.del(n)}),this.transMap=new o,e(n)};var t=this.chain.shift();t.action.call(this,t.uuid,this.flush)},on:function(e,t){var n=this.events.get(e);n||(n=[],this.events.set(e,n)),n.push(t)}},a.prototype.discard=function(e){try{this.trans.abortAll(),(e||function(){})("OK")}catch(t){this.handleError(t)}},a.prototype.handleError=function(){var e=r.call(arguments);(this.events.get("error")||[]).forEach(function(t){t.apply(null,e)})},a.prototype.get=function(e,t){var n=this;return this.register("read",function(t,r){c(function(i){var s=n.trans.pull(i,n.osName,t,IDBTransaction.READ_ONLY),o=s.objectStore(n.osName).get(e);o.onerror=n.handleError.bind(n),o.onsuccess=function(e){r.call(n,e.target.result)}},n.handleError.bind(n))},t),this},a.prototype.set=function(e,t,n){var r=this;return this.register("write",function(n,i){c(function(s){var o=r.trans.pull(s,r.osName,n,IDBTransaction.READ_WRITE),u=o.objectStore(r.osName).put(t,e);u.onerror=r.handleError.bind(r),u.onsuccess=function(t){var n=t.target.result===e?"OK":"ERR";i.call(r,n)}},r.handleError.bind(r))},n),this},a.prototype.incrby=function(e,r,i){var s=this;return this.register("write",function(i,o){c(function(u){var a=s.trans.pull(u,s.osName,i,IDBTransaction.READ_WRITE),f=a.objectStore(s.osName);(function l(i){if(!t(i)){var u=f.get(e);u.onerror=s.handleError.bind(s),u.onsuccess=function(e){l(typeof e.target.result=="undefined"?0:e.target.result)};return}if(!n(i)){s.handleError("ERROR: Cannot increment a non-integer value.");return}var a=i+r,u=f.put(a,e);u.onerror=s.handleError.bind(s),u.onsuccess=function(t){var n=t.target.result===e?a:"ERR";o.call(s,n)}})()},s.handleError.bind(s))},i),this},a.prototype.incr=function(e,t){return this.incrby(e,1,t)},a.prototype.decrby=function(e,t,n){return this.incrby(e,-t,n)},a.prototype.decr=function(e,t){return this.incrby(e,-1,t)},a.prototype.del=function(){var e=this,t=r.call(arguments),n=t[t.length>0?t.length-1:0];typeof n!="function"?n=undefined:t.splice(t.length-1);var i=t,s=i.length;return this.register("write",function(t,n){c(function(r){var o=e.trans.pull(r,e.osName,t,IDBTransaction.READ_WRITE),u=o.objectStore(e.osName),a=i.length;while(i.length>0)(function(){var t=i.shift(),r=u.delete(t);r.onerror=e.handleError.bind(e),r.onsuccess=function(t){a--,a===0&&n.call(e,s)}})()})},n),this},e.print=function(){var e=r.call(arguments);if(e.length===0)return;(e[0]instanceof Array?e[0]:[e[0]]).forEach(function(e){console.log(e)})},e.version=1,e.dbName="gazeldb",e.osName="gazelos",e.compatible=t(window.indexedDB)&&t(window.IDBTransaction),e.createClient=function(t){var n=new a;return n.osName=t||e.osName,t&&(n.needsOsVerification=!0),n},this.gazel=e;var f,l=!1}).call(this);