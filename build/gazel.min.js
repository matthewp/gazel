(function(){function f(a,b){for(b=a="";a++<36;b+=a*51&52?(a^15?8^Math.random()*(a^20?16:4):4).toString(16):"-");return b}function g(){this.items={}}function h(){g.call(this)}function i(){this.chain=[],this.inMulti=!1,this.returned=[],this.trans=new h,this.transMap=new g,this.events=new g}function l(b,c,d){if(j&&j.version==a.version){b(j);return}if(k){setTimeout(function(){l(b,c)},100);return}k=!0;var e=window.indexedDB.open(a.dbName,a.version);e.onupgradeneeded=function(b){var c=b.target.result;c.objectStoreNames.contains(a.osName)||c.createObjectStore(a.osName),d&&d(c)};var f;f=e.onsuccess=function(d){var g=d.target.result;if(g.setVersion&&Number(g.version)!==a.version){j&&j.close();var h=g.setVersion(String(a.version));h.onsuccess=function(a){var b={};b.target={},b.target.result=a.target.result.db,e.onupgradeneeded(b),f(b);return},h.onerror=c,h.onfailure=c,h.onblocked=c;return}j=g,k=!1,b(j)},e.onerror=c}function m(b,c,d){a.version++,l(function(){c()},d,function(a){a.objectStoreNames.contains(b)||a.createObjectStore(b)})}var a=a||{},b=function(a){return typeof a!="undefined"&&a!=null},c=function(a){return!isNaN(a)&&a%1==0};window.indexedDB=window.indexedDB||window.mozIndexedDB||window.msIndexedDB||window.webkitIndexedDB||window.oIndexedDB,window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction,window.IDBTransaction.READ_ONLY=window.IDBTransaction.READ_ONLY||"readonly",window.IDBTransaction.READ_WRITE=window.IDBTransaction.READ_WRITE||"readwrite";var d=Array.prototype.slice,e=Array.prototype.splice;g.prototype={prop:function(a){return":"+a},get:function(a,b){var c=this.prop(a),d=this.items;return d.hasOwnProperty(c)?d[c]:b},set:function(a,b){var c=this.prop(a);return this.items[c]=b,b},count:function(){return Object.keys(this.items).length},has:function(a){var b=this.prop(a);return this.items.hasOwnProperty(b)},del:function(a){var b=this.prop(a),c=this.items;c.hasOwnProperty(b)&&delete c[b]},keys:function(){return Object.keys(this.items).map(function(a){return a.substring(1)})}},h.prototype=g.prototype,h.prototype.constructor=h,h.prototype.add=function(){var a=f();return this.set(a,undefined),a},h.prototype.abortAll=function(){var a=this,b=a.keys();b.forEach(function(b){var c=a.get(b);c&&c.abort(),a.del(b)})},h.prototype.pull=function(a,b,c,d){var e=this.get(c);return e||(e=a.transaction([b],d),e.onerror=onerror,this.set(c,e)),e},i.prototype={register:function(a,b,c){var e,f=this;if(this.needsOsVerification){m(this.osName,function(){f.needsOsVerification=!1,f.register(a,b,c)},this.handleError.bind(this));return}if(this.inMulti){e=this.transMap.get(a),e||(e=this.trans.add(),this.transMap.set(a,e)),this.chain.push({uuid:e,action:b});return}e=f.trans.add(),b(e,function(){var a=d.call(arguments);f.trans.del(e),(c||function(){}).apply(null,a)})},flush:function(){var a=d.call(arguments)||[];this.returned.push(a);if(this.chain.length===0){this.complete();return}var b=this.chain.shift();b.action.call(this,b.uuid,this.flush)},multi:function(){return this.chain=[],this.inMulti=!0,this},exec:function(a){this.inMulti=!1,this.complete=function(){var b=this,c=this.returned;this.complete=null,this.chain=null,this.returned=[],this.transMap.keys().forEach(function(a){var c=b.transMap.get(a);b.trans.del(c)}),this.transMap=new g,a(c)};var b=this.chain.shift();b.action.call(this,b.uuid,this.flush)},on:function(a,b){var c=this.events.get(a);c||(c=[],this.events.set(a,c)),c.push(b)}},i.prototype.discard=function(a){try{this.trans.abortAll(),(a||function(){})("OK")}catch(b){this.handleError(b)}},i.prototype.handleError=function(){var a=d.call(arguments);(this.events.get("error")||[]).forEach(function(b){b.apply(null,a)})},i.prototype.get=function(a,b){var c=this;return this.register("read",function(b,d){l(function(e){var f=c.trans.pull(e,c.osName,b,IDBTransaction.READ_ONLY),g=f.objectStore(c.osName).get(a);g.onerror=c.handleError.bind(c),g.onsuccess=function(a){d.call(c,a.target.result)}},c.handleError.bind(c))},b),this},i.prototype.set=function(a,b,c){var d=this;return this.register("write",function(c,e){l(function(f){var g=d.trans.pull(f,d.osName,c,IDBTransaction.READ_WRITE),h=g.objectStore(d.osName).put(b,a);h.onerror=d.handleError.bind(d),h.onsuccess=function(b){var c=b.target.result===a?"OK":"ERR";e.call(d,c)}},d.handleError.bind(d))},c),this},i.prototype.incrby=function(a,d,e){var f=this;return this.register("write",function(e,g){l(function(h){var i=f.trans.pull(h,f.osName,e,IDBTransaction.READ_WRITE),j=i.objectStore(f.osName);(function k(e){if(!b(e)){var h=j.get(a);h.onerror=f.handleError.bind(f),h.onsuccess=function(a){k(typeof a.target.result=="undefined"?0:a.target.result)};return}if(!c(e)){f.handleError("ERROR: Cannot increment a non-integer value.");return}var i=e+d,h=j.put(i,a);h.onerror=f.handleError.bind(f),h.onsuccess=function(b){var c=b.target.result===a?i:"ERR";g.call(f,c)}})()},f.handleError.bind(f))},e),this},i.prototype.incr=function(a,b){return this.incrby(a,1,b)},i.prototype.decrby=function(a,b,c){return this.incrby(a,-b,c)},i.prototype.decr=function(a,b){return this.incrby(a,-1,b)},i.prototype.del=function(){var a=this,b=d.call(arguments),c=b[b.length>0?b.length-1:0];typeof c!="function"?c=undefined:b.splice(b.length-1);var e=b,f=e.length;return this.register("write",function(b,c){l(function(d){var g=a.trans.pull(d,a.osName,b,IDBTransaction.READ_WRITE),h=g.objectStore(a.osName),i=e.length;while(e.length>0)(function(){var b=e.shift(),d=h.delete(b);d.onerror=a.handleError.bind(a),d.onsuccess=function(b){i--,i===0&&c.call(a,f)}})()})},c),this},a.print=function(){var a=d.call(arguments);if(a.length===0)return;(a[0]instanceof Array?a[0]:[a[0]]).forEach(function(a){console.log(a)})},a.version=1,a.dbName="gazeldb",a.osName="gazelos",a.compatible=b(window.indexedDB)&&b(window.IDBTransaction),a.createClient=function(b){var c=new i;return c.osName=b||a.osName,b&&(c.needsOsVerification=!0),c},this.gazel=a;var j,k=!1}).call(this);