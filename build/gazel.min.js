(function(){function s(e,t){for(t=e="";e++<36;t+=e*51&52?(e^15?8^Math.random()*(e^20?16:4):4).toString(16):"-");return t}function o(){this.items={}}function u(){o.call(this)}function a(){this.chain=[],this.inMulti=!1,this.returned=[],this.trans=new u,this.transMap=new o,this.events=new o}function c(t,n,r){if(f&&f.version==e.version&&f.name===e.dbName){t(f);return}if(l){setTimeout(function(){c(t,n)},100);return}l=!0;var i=window.indexedDB.open(e.dbName,e.version);i.onupgradeneeded=function(t){var n=t.target.result;[e.osName,e.setsOsName].forEach(function(e){n.objectStoreNames.contains(e)||n.createObjectStore(e)}),r&&r(n)};var s;s=i.onsuccess=function(r){var o=r.target.result;if(o.setVersion&&Number(o.version)!==e.version){f&&f.close();var u=o.setVersion(String(e.version));u.onsuccess=function(e){var t={};t.target={},t.target.result=e.target.result.db,i.onupgradeneeded(t),s(t);return},u.onerror=n,u.onfailure=n,u.onblocked=n;return}f=o,l=!1,t(f)},i.onerror=function(i){if(i&&i.target.errorCode===12){e.version++,c(t,n,r);return}n(i)},i.onblocked=n}function h(t,n,r){c(function(i){if(!i.objectStoreNames.contains(t)){i.close(),e.version++,h(t,n,r);return}n()},r,function(e){e.objectStoreNames.contains(t)||e.createObjectStore(t)})}function p(e,t,n,r,i,s,o,u){c(function(a){var f=t.pull(a,e,n,u||IDBTransaction.READ_ONLY),l=f.objectStore(e).get(r);l.onerror=s,l.onsuccess=function(e){i.call(o,e.target.result)}},s)}function d(e,t,n,r,i,s,o,u){c(function(a){var f=t.pull(a,e,n,IDBTransaction.READ_WRITE),l=f.objectStore(e).put(i,r);l.onerror=o,l.onsuccess=function(e){var t=e.target.result===r?"OK":"ERR";s.call(u,t)}},o)}function v(e,t,n,r,i,s,o){c(function(u){var a=t.pull(u,e,n,IDBTransaction.READ_WRITE),f=a.objectStore(e),l=r.length;while(r.length>0)(function(){var e=r.shift(),t=f.delete(e);t.onerror=s,t.onsuccess=function(e){r.length===0&&i.call(o,l)}})()})}var e=e||{},t=function(e){return typeof e!="undefined"&&e!=null},n=function(e){return!isNaN(e)&&e%1==0};window.indexedDB=window.indexedDB||window.mozIndexedDB||window.msIndexedDB||window.webkitIndexedDB||window.oIndexedDB,window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction,window.IDBTransaction.READ_ONLY=window.IDBTransaction.READ_ONLY||"readonly",window.IDBTransaction.READ_WRITE=window.IDBTransaction.READ_WRITE||"readwrite";var r=Array.prototype.slice,i=Array.prototype.splice;o.prototype={prop:function(e){return":"+e},get:function(e,t){var n=this.prop(e),r=this.items;return r.hasOwnProperty(n)?r[n]:t},set:function(e,t){var n=this.prop(e);return this.items[n]=t,t},count:function(){return Object.keys(this.items).length},has:function(e){var t=this.prop(e);return this.items.hasOwnProperty(t)},del:function(e){var t=this.prop(e),n=this.items;n.hasOwnProperty(t)&&delete n[t]},keys:function(){return Object.keys(this.items).map(function(e){return e.substring(1)})}},u.prototype=o.prototype,u.prototype.constructor=u,u.prototype.add=function(){var e=s();return this.set(e,undefined),e},u.prototype.abortAll=function(){var e=this,t=e.keys();t.forEach(function(t){var n=e.get(t);n&&n.abort(),e.del(t)})},u.prototype.pull=function(e,t,n,r){var i=this.get(n);return i||(i=e.transaction([t],r),i.onerror=onerror,this.set(n,i)),i},a.prototype={register:function(e,t,n){var i,s=this;if(this.inMulti){i=this.transMap.get(e),i||(i=this.trans.add(),this.transMap.set(e,i)),this.chain.push({uuid:i,action:t});return}i=s.trans.add(),t(i,function(){var e=r.call(arguments);s.trans.del(i),(n||function(){}).apply(null,e)})},flush:function(){var e=r.call(arguments)||[];this.returned.push(e);if(this.chain.length===0){this.complete();return}var t=this.chain.shift();t.action.call(this,t.uuid,this.flush)},multi:function(){return this.chain=[],this.inMulti=!0,this},exec:function(e){this.inMulti=!1,this.complete=function(){var t=this,n=this.returned;this.complete=null,this.chain=null,this.returned=[],this.transMap.keys().forEach(function(e){var n=t.transMap.get(e);t.trans.del(n)}),this.transMap=new o,e(n)};var t=this.chain.shift();t.action.call(this,t.uuid,this.flush)},on:function(e,t){var n=this.events.get(e);n||(n=[],this.events.set(e,n)),n.push(t)}},a.prototype.discard=function(e){try{this.trans.abortAll(),(e||function(){})("OK")}catch(t){this.handleError(t)}},a.prototype.handleError=function(){var e=r.call(arguments);(this.events.get("error")||[]).forEach(function(t){t.apply(null,e)})},a.prototype.get=function(t,n){var r=this;return this.register("read",function(n,i){p(e.osName,r.trans,n,t,i,r.handleError.bind(r),r)},n),this},a.prototype.set=function(t,n,r){var i=this,s=e.osName;return this.register("write",function(r,s){d(e.osName,i.trans,r,t,n,s,i.handleError.bind(i),i)},r),this},a.prototype.incrby=function(t,r,i){var s=this;return this.register("write",function(i,o){var u=s.handleError.bind(s),a=e.osName,f=s.trans;p(a,f,i,t,function(e){e=e||0;if(!n(e)){s.handleError("ERROR: Cannot increment a non-integer value.");return}var l=e+r;d(a,f,i,t,l,function(e){o.call(s,e==="OK"?l:"ERR")},u,s)},u,s,IDBTransaction.READ_WRITE)},i),this},a.prototype.incr=function(e,t){return this.incrby(e,1,t)},a.prototype.decrby=function(e,t,n){return this.incrby(e,-t,n)},a.prototype.decr=function(e,t){return this.incrby(e,-1,t)},a.prototype.del=function(){var t=this,n=r.call(arguments),i=n[n.length>0?n.length-1:0];typeof i!="function"?i=undefined:n.splice(n.length-1);var s=n;return this.register("write",function(n,r){v(e.osName,t.trans,n,s,r,t.handleError.bind(t),t)},i),this},e.print=function(){var e=r.call(arguments);if(e.length===0)return;(e[0]instanceof Array?e[0]:[e[0]]).forEach(function(e){console.log(e)})},e.dbName="gazeldb",e.osName="gazelos",e.setsOsName="gazelos.sets",e.version=2,e.compatible=t(window.indexedDB)&&t(window.IDBTransaction),e.createClient=function(){return new a},this.gazel=e;var f,l=!1}).call(this);