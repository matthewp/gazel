(function(e){function o(e,t){for(t=e="";e++<36;t+=e*51&52?(e^15?8^Math.random()*(e^20?16:4):4).toString(16):"-");return t}function u(){this.items={}}function a(){u.call(this)}function f(){this.chain=[],this.inMulti=!1,this.returned=[],this.trans=new a,this.transMap=new u,this.events=new u}function h(e,n,r){if(l&&l.version==t.version&&l.name===t.dbName){e(l);return}if(c){setTimeout(function(){h(e,n)},100);return}c=!0;var i=window.indexedDB.open(t.dbName,t.version);i.onupgradeneeded=function(e){var n=e.target.result;n.objectStoreNames.contains(t.osName)||n.createObjectStore(t.osName);if(!n.objectStoreNames.contains(t.setsOsName)){var i=n.createObjectStore(t.setsOsName);i.createIndex("key","key",{unique:!1})}r&&r(n)};var s;s=i.onsuccess=function(r){var o=r.target.result;if(o.setVersion&&Number(o.version)!==t.version){l&&l.close();var u=o.setVersion(String(t.version));u.onsuccess=function(e){var t={};t.target={},t.target.result=e.target.result.db,i.onupgradeneeded(t),s(t);return},u.onerror=n,u.onfailure=n,u.onblocked=n;return}l=o,c=!1,e(l)},i.onerror=function(i){if(i&&i.target.errorCode===12){t.version++,h(e,n,r);return}n(i)},i.onblocked=n}function p(e,n,r){h(function(i){if(!i.objectStoreNames.contains(e)){i.close(),t.version++,p(e,n,r);return}n()},r,function(t){t.objectStoreNames.contains(e)||t.createObjectStore(e)})}function d(e,t,n,r,i,s,o,u){h(function(a){var f=t.pull(a,e,n,u||IDBTransaction.READ_ONLY),l=f.objectStore(e).get(r);l.onerror=s,l.onsuccess=function(e){i.call(o,e.target.result)}},s)}function v(e,t,n,r,i,s,o,u){h(function(a){var f=t.pull(a,e,n,IDBTransaction.READ_WRITE),l=f.objectStore(e).put(i,r);l.onerror=o,l.onsuccess=function(e){var t=e.target.result===r?"OK":"ERR";s.call(u,t)}},o)}function m(e,t,n,r,i,s,o){h(function(u){var a=t.pull(u,e,n,IDBTransaction.READ_WRITE),f=a.objectStore(e),l=r.length,c=r.length;while(r.length>0)(function(){var e=r.shift(),t=f.delete(e);t.onerror=s,t.onsuccess=function(e){l--,l===0&&i.call(o,c)}})()})}function g(e,t,n,r,i,s,o,u,a){h(function(o){var f=t.pull(o,e,n,a||IDBTransaction.READ_ONLY),l=f.objectStore(e).index(r),c=window.IDBKeyRange.only(i);l.openCursor(c).onsuccess=function(e){var t=e.target.result;t?s.call(u,t.value)&&t.continue():s.call(u)}})}var t=t||{},n=function(e){return typeof e!="undefined"&&e!=null},r=function(e){return!isNaN(e)&&e%1==0};window.indexedDB=window.indexedDB||window.mozIndexedDB||window.msIndexedDB||window.webkitIndexedDB||window.oIndexedDB,window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction,window.IDBTransaction.READ_ONLY=window.IDBTransaction.READ_ONLY||"readonly",window.IDBTransaction.READ_WRITE=window.IDBTransaction.READ_WRITE||"readwrite",window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange;var i=Array.prototype.slice,s=Array.prototype.splice;u.prototype={prop:function(e){return":"+e},get:function(e,t){var n=this.prop(e),r=this.items;return r.hasOwnProperty(n)?r[n]:t},set:function(e,t){var n=this.prop(e);return this.items[n]=t,t},count:function(){return Object.keys(this.items).length},has:function(e){var t=this.prop(e);return this.items.hasOwnProperty(t)},del:function(e){var t=this.prop(e),n=this.items;n.hasOwnProperty(t)&&delete n[t]},keys:function(){return Object.keys(this.items).map(function(e){return e.substring(1)})}},a.prototype=Object.create(u.prototype),a.prototype.constructor=a,a.prototype.add=function(){var t=o();return this.set(t,e),t},a.prototype.abortAll=function(){var e=this,t=e.keys();t.forEach(function(t){var n=e.get(t);n&&n.abort(),e.del(t)})},a.prototype.pull=function(e,t,n,r){var i=this.get(n);return i||(i=e.transaction([t],r),i.onerror=onerror,this.set(n,i)),i},f.prototype={register:function(e,t,n){var r,s=this;if(this.inMulti){r=this.transMap.get(e),r||(r=this.trans.add(),this.transMap.set(e,r)),this.chain.push({uuid:r,action:t});return}r=s.trans.add(),t(r,function(){var e=i.call(arguments);s.trans.del(r),(n||function(){}).apply(null,e)})},flush:function(){var e=i.call(arguments)||[];this.returned.push(e);if(this.chain.length===0){this.complete();return}var t=this.chain.shift();t.action.call(this,t.uuid,this.flush)},multi:function(){return this.chain=[],this.inMulti=!0,this},exec:function(e){this.inMulti=!1,this.complete=function(){var t=this,n=this.returned;this.complete=null,this.chain=null,this.returned=[],this.transMap.keys().forEach(function(e){var n=t.transMap.get(e);t.trans.del(n)}),this.transMap=new u,e(n)};var t=this.chain.shift();t.action.call(this,t.uuid,this.flush)},on:function(e,t){var n=this.events.get(e);n||(n=[],this.events.set(e,n)),n.push(t)}},f.prototype.discard=function(e){try{this.trans.abortAll(),(e||function(){})("OK")}catch(t){this.handleError(t)}},f.prototype.handleError=function(){var e=i.call(arguments);(this.events.get("error")||[]).forEach(function(t){t.apply(null,e)})},f.prototype.get=function(e,n){var r=this;return this.register("read",function(n,i){d(t.osName,r.trans,n,e,i,r.handleError.bind(r),r)},n),this},f.prototype.set=function(e,n,r){var i=this;return this.register("write",function(r,s){v(t.osName,i.trans,r,e,n,s,i.handleError.bind(i),i)},r),this},f.prototype.incrby=function(e,n,i){var s=this;return this.register("write",function(i,o){var u=s.handleError.bind(s),a=t.osName,f=s.trans;d(a,f,i,e,function(t){t=t||0;if(!r(t)){u("ERROR: Cannot increment a non-integer value.");return}var l=t+n;v(a,f,i,e,l,function(e){o.call(s,e==="OK"?l:"ERR")},u,s)},u,s,IDBTransaction.READ_WRITE)},i),this},f.prototype.incr=function(e,t){return this.incrby(e,1,t)},f.prototype.decrby=function(e,t,n){return this.incrby(e,-t,n)},f.prototype.decr=function(e,t){return this.incrby(e,-1,t)},f.prototype.del=function(){var n=this,r=i.call(arguments),s=r[r.length>0?r.length-1:0];typeof s!="function"?s=e:r.splice(r.length-1);var o=r;return this.register("write",function(e,r){m(t.osName,n.trans,e,o,r,n.handleError.bind(n),n)},s),this},f.prototype.sadd=function(e,n,r){var i=this,s=this.inMulti;return s||this.multi(),this.register("write",function(r,s){var o=i.handleError.bind(i);d(t.osName,i.trans,r,e,function(u){if(u&&n in u){s.call(i,"OK");return}u||(u=[]),u.push(":"+n.toString()),v(t.osName,i.trans,r,e,u,s,o,i)},o,i,IDBTransaction.READ_WRITE)},r),s||this.exec(),this},f.prototype.smembers=function(n,r){var i=this;return this.register("read",function(r,s){d(t.osName,i.trans,r,n,function(t){if(!t){s.call(i,e);return}var n=t.map(function(e){return e.split(":").splice(1).join(":")});s.call(i,n)},i.handleError.bind(i),i)},r),this},f.prototype.scard=function(e,t){return this.smembers(e,function(e){t(e.length||0)}),this},f.prototype.sismember=function(e,t,n){var r=this;return typeof t!="string"&&(t=t.toString()),this.register("read",function(n,i){r.smembers(e,function(e){var n=e.some(function(e){return t===e});i.call(r,n)})},n),this},t.print=function(){var e=i.call(arguments);if(e.length===0)return;(e[0]instanceof Array?e[0]:[e[0]]).forEach(function(e){console.log(e)})},t.dbName="gazeldb",t.osName="gazelos",t.setsOsName="gazelos.sets",t.version=2,t.compatible=n(window.indexedDB)&&n(window.IDBTransaction),t.createClient=function(){return new f},this.gazel=t;var l,c=!1}).call(this);